<section class="wrap">
  <div class="main-container">
    <div class="content">
      <!-- Header con búsqueda -->
      <div class="header-section">
        <h1 class="page-title" [class.subscribed-mode]="showOnlySubscribed">
          <mat-icon>school</mat-icon>
          {{ showOnlySubscribed ? 'Mis Materias' : 'Materias Disponibles' }}
        </h1>
        <div class="toolbar-actions">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar materias</mat-label>
            <input matInput [value]="query()" (input)="query.set($any($event.target).value)" placeholder="Buscar...">
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="reload()" [disabled]="loading">
            <mat-icon>refresh</mat-icon>
            {{ loading ? 'Cargando...' : 'Actualizar' }}
          </button>
        </div>
      </div>

      <!-- Filtros y navegación -->
      <div class="filter-actions" *ngIf="!isAdmin()">
        <button mat-raised-button [color]="showOnlySubscribed ? 'primary' : 'basic'" (click)="toggleFilter()">
          <mat-icon>{{ showOnlySubscribed ? 'filter_alt' : 'filter_alt_off' }}</mat-icon>
          {{ showOnlySubscribed ? 'Mostrar Todas Las Materias' : 'Mostrar Solo Mis Materias' }}
        </button>
        <button mat-raised-button color="accent" (click)="goToSubscriptions()">
          <mat-icon>settings</mat-icon>
          Gestionar suscripciones
        </button>
      </div>

      <!-- Progress bar -->
      <mat-progress-bar *ngIf="loading" mode="indeterminate" color="accent"></mat-progress-bar>

      <!-- Estados vacíos -->
      <div class="empty-state" *ngIf="!loading && all().length === 0">
        <mat-icon class="empty-icon">menu_book</mat-icon>
        <h3>{{ showOnlySubscribed ? 'No tienes suscripciones activas' : (isAdmin() ? 'No hay materias todavía' : 'No hay materias disponibles') }}</h3>
        <p>{{ showOnlySubscribed ? 'Ve a "Gestionar suscripciones" para suscribirte a materias' : (isAdmin() ? 'Comienza agregando tu primera materia abajo' : 'Pronto se agregarán materias al sistema') }}</p>
      </div>

      <div class="empty-state" *ngIf="!loading && all().length > 0 && filtered().length === 0">
        <mat-icon class="empty-icon">search_off</mat-icon>
        <h3>No se encontraron resultados</h3>
        <p>Intenta con otro término de búsqueda</p>
      </div>

      <!-- Lista de materias con MatCard -->
      <div class="subjects-grid" *ngIf="!loading && filtered().length > 0">
        <mat-card *ngFor="let s of filtered()" class="subject-card" [class.subscribed-mode]="showOnlySubscribed">
          <mat-card-header>
            <mat-card-title>{{ s.name }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="subject-field">
              <mat-icon>flag</mat-icon>
              <div>
                <strong>Objetivo:</strong>
                <p>{{ s.objective }}</p>
              </div>
            </div>
            <div class="subject-field">
              <mat-icon>description</mat-icon>
              <div>
                <strong>Contenido:</strong>
                <p>{{ s.content }}</p>
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions *ngIf="isAdmin()">
            <button mat-button color="primary" (click)="edit(s)">
              <mat-icon>edit</mat-icon>
              Editar
            </button>
            <button mat-button color="warn" (click)="remove(s)">
              <mat-icon>delete</mat-icon>
              Eliminar
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <!-- Formulario de agregar materia (solo admin) -->
      <mat-card class="add-card" *ngIf="isAdmin()">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>add_circle</mat-icon>
            Agregar Nueva Materia
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-progress-bar *ngIf="loadingAdd" mode="indeterminate" color="accent"></mat-progress-bar>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre de la materia</mat-label>
            <input matInput [(ngModel)]="newName" [disabled]="loadingAdd" placeholder="Ej: Programación">
            <mat-icon matPrefix>subject</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Objetivo</mat-label>
            <textarea matInput [(ngModel)]="newObjective" [disabled]="loadingAdd" rows="2" placeholder="Objetivo de la materia"></textarea>
            <mat-icon matPrefix>flag</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Contenido</mat-label>
            <textarea matInput [(ngModel)]="newContent" [disabled]="loadingAdd" rows="3" placeholder="Contenido del curso"></textarea>
            <mat-icon matPrefix>description</mat-icon>
          </mat-form-field>

          <button mat-raised-button color="primary" (click)="add()" [disabled]="loadingAdd" class="add-btn">
            <mat-icon>add</mat-icon>
            {{ loadingAdd ? 'Agregando...' : 'Agregar Materia' }}
          </button>
        </mat-card-content>
      </mat-card>
    </div>

    <aside class="sidebar">
      <app-calendar></app-calendar> <!--Calendario-->
    </aside>
  </div>
</section>
